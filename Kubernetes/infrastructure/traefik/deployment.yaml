apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: ./kompose -f ./compose.yaml convert
    kompose.version: 1.34.0 (cbf2835db)
    traefik.enable: "true"
    traefik.http.middlewares.crowdsec.plugin.crowdsec.crowdseclapikey: ""
    traefik.http.middlewares.crowdsec.plugin.crowdsec.enabled: "true"
    traefik.http.middlewares.default-headers.headers.contentTypeNosniff: "true"
    traefik.http.routers.traefik.middlewares: default-headers
    traefik.http.services.traefik.loadbalancer.server.port: "8080"
  labels:
    io.kompose.service: traefik
  name: traefik
  namespace: infrastructure
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: traefik
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.cmd: ./kompose -f ./compose.yaml convert
        kompose.version: 1.34.0 (cbf2835db)
        traefik.enable: "true"
        traefik.http.middlewares.crowdsec.plugin.crowdsec.crowdseclapikey: ""
        traefik.http.middlewares.crowdsec.plugin.crowdsec.enabled: "true"
        traefik.http.middlewares.default-headers.headers.contentTypeNosniff: "true"
        traefik.http.routers.traefik.middlewares: default-headers
        traefik.http.services.traefik.loadbalancer.server.port: "8080"
      labels:
        io.kompose.service: traefik
    spec:
      containers:
        - args:
            - --api.dashboard=true
            - --api.insecure=true
            - --ping=true
            - --accesslog
            - --accesslog.filepath=/var/log/traefik/access.log
            - --entrypoints.web.address=:80
            - --entrypoints.web.http.redirections.entryPoint.to=websecure
            - --entrypoints.websecure.address=:443
            - --entryPoints.web.proxyProtocol.trustedIPs=100.64.0.0/10
            - --entryPoints.web.forwardedHeaders.trustedIPs=100.64.0.0/10
            - --entryPoints.websecure.proxyProtocol.trustedIPs=100.64.0.0/10
            - --entryPoints.websecure.forwardedHeaders.trustedIPs=100.64.0.0/10
            - --entrypoints.websecure.http.tls=true
            - --entrypoints.websecure.http.tls.certresolver=cloudflare
            - --entrypoints.websecure.http.tls.domains[0].main=nerine.dev
            - --entrypoints.websecure.http.tls.domains[0].sans=*.nerine.dev
            - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
            - --certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1
            - --certificatesResolvers.cloudflare.acme.storage=/cert/acme.json
            - --global.sendAnonymousUsage=true
            - --providers.file.directory=/config
            - --providers.file.watch=true
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --providers.docker.defaultRule=Host(`{{ or (index .Labels "subdomain") (lower
              .ContainerName)}}.nerine.dev`)
            - --experimental.plugins.crowdsec.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
            - --experimental.plugins.crowdsec.version=v1.4.1
          env:
            - name: CF_DNS_API_TOKEN
            - name: TZ
              value: Europe/Warsaw
          image: traefik:v3.5
          livenessProbe:
            exec:
              command:
                - traefik
                - healthcheck
                - --ping
            failureThreshold: 5
            initialDelaySeconds: 30
            periodSeconds: 90
            timeoutSeconds: 30
          name: traefik
          ports:
            - containerPort: 80
            - containerPort: 443
          volumeMounts:
            - mountPath: /var/log/traefik
              name: traefik-claim1
            - mountPath: /config
              name: traefik-claim2
            - mountPath: /cert
              name: traefik-claim3
      restartPolicy: Always
      volumes:
        - name: traefik-claim1
          persistentVolumeClaim:
            claimName: traefik-claim1
        - name: traefik-claim2
          persistentVolumeClaim:
            claimName: traefik-claim2
        - name: traefik-claim3
          persistentVolumeClaim:
            claimName: traefik-claim3
