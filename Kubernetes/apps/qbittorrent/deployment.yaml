# =============================================================================
# qBittorrent Deployment
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qbittorrent
  namespace: media
  labels:
    app: qbittorrent
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      initContainers:
        - name: config-init
          image: linuxserver/qbittorrent:20.04.1
          command:
            - /bin/sh
            - -c
            - |
              set -eu
              CONFIG_DIR="/config/qBittorrent"
              CONFIG_FILE="${CONFIG_DIR}/qBittorrent.conf"
              mkdir -p "${CONFIG_DIR}"
              if [ ! -f "${CONFIG_FILE}" ]; then
                HASH="$(qbittorrent-nox --hash-password "${QBT_WEBUI_PASSWORD}" | tail -n 1)"
                cat > "${CONFIG_FILE}" <<EOF
              [Preferences]
              WebUI\\Username=${QBT_WEBUI_USERNAME}
              WebUI\\Password_PBKDF2=${HASH}
              WebUI\\Port=8080
              EOF
                chmod 600 "${CONFIG_FILE}"
              fi
              # Ensure API access settings for cluster-internal services
              if ! grep -q 'CSRFProtection' "${CONFIG_FILE}"; then
                sed -i '/^\[Preferences\]/a WebUI\\CSRFProtection=false' "${CONFIG_FILE}"
              fi
              if ! grep -q 'AuthSubnetWhitelistEnabled' "${CONFIG_FILE}"; then
                sed -i '/^\[Preferences\]/a WebUI\\AuthSubnetWhitelistEnabled=true' "${CONFIG_FILE}"
              fi
              if ! grep -q 'AuthSubnetWhitelist' "${CONFIG_FILE}" || ! grep -q 'AuthSubnetWhitelist=' "${CONFIG_FILE}"; then
                sed -i '/^\[Preferences\]/a WebUI\\AuthSubnetWhitelist=10.244.0.0/16,10.96.0.0/12' "${CONFIG_FILE}"
              fi
              if ! grep -q 'HostHeaderValidation' "${CONFIG_FILE}"; then
                sed -i '/^\[Preferences\]/a WebUI\\HostHeaderValidation=false' "${CONFIG_FILE}"
              fi
              # Set download path to shared volume
              if ! grep -q '^\[BitTorrent\]' "${CONFIG_FILE}"; then
                printf '\n[BitTorrent]\nSession\\DefaultSavePath=/downloads\n' >> "${CONFIG_FILE}"
              elif ! grep -q 'DefaultSavePath' "${CONFIG_FILE}"; then
                sed -i '/^\[BitTorrent\]/a Session\\DefaultSavePath=/downloads' "${CONFIG_FILE}"
              else
                sed -i 's|Session\\DefaultSavePath=.*|Session\\DefaultSavePath=/downloads|' "${CONFIG_FILE}"
              fi
          env:
            - name: QBT_WEBUI_USERNAME
              valueFrom:
                secretKeyRef:
                  name: qbittorrent-webui
                  key: username
            - name: QBT_WEBUI_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: qbittorrent-webui
                  key: password
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        - name: qbittorrent
          image: linuxserver/qbittorrent:20.04.1
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "002"
            - name: DOCKER_MODS
              value: ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
          ports:
            - name: http
              containerPort: 8080
            - name: bittorrent-tcp
              containerPort: 6881
              protocol: TCP
            - name: bittorrent-udp
              containerPort: 6881
              protocol: UDP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: downloads
              mountPath: /downloads
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: qbittorrent-config
        - name: downloads
          persistentVolumeClaim:
            claimName: downloads-pvc
