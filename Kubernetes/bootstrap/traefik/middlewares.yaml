# =============================================================================
# Traefik Middlewares
# =============================================================================
---
# Security Headers - Applied globally to all routes
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: traefik
spec:
  headers:
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
    forceSTSHeader: true
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: "strict-origin-when-cross-origin"
    frameDeny: true
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "SAMEORIGIN"
      X-XSS-Protection: "1; mode=block"
      Permissions-Policy: "geolocation=(), microphone=(), camera=()"
---
# Tailscale Only - Restrict to Tailscale CGNAT range
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: tailscale-only
  namespace: traefik
spec:
  ipAllowList:
    sourceRange:
      - "100.64.0.0/10" # Tailscale CGNAT range
      - "10.100.0.0/24" # Cluster VLAN
      - "10.244.0.0/16" # Pod CIDR
---
# Standard Timeout - 60s read/write, 180s idle
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: timeout-standard
  namespace: traefik
spec:
  # Note: Traefik v3 uses InFlightReq for connection limiting
  # Timeout is handled at entry point level
  inFlightReq:
    amount: 100
---
# Streaming Timeout - Unlimited for media
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: timeout-streaming
  namespace: traefik
spec:
  inFlightReq:
    amount: 500 # Higher limit for streaming
---
# Rate Limit - 100 req/min, burst 200
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: traefik
spec:
  rateLimit:
    average: 100
    burst: 200
    period: 1m
---
# Rate Limit Streaming - 1000 req/min
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit-streaming
  namespace: traefik
spec:
  rateLimit:
    average: 1000
    burst: 2000
    period: 1m
---
# CrowdSec Bouncer - ForwardAuth to CrowdSec
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: crowdsec
  namespace: traefik
spec:
  forwardAuth:
    address: http://crowdsec-bouncer.crowdsec.svc.cluster.local:8080/api/v1/forwardAuth
    trustForwardHeader: true
---
# Public Chain - For public web services
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: public-chain
  namespace: traefik
spec:
  chain:
    middlewares:
      - name: crowdsec
      - name: rate-limit
      - name: timeout-standard
---
# Streaming Chain - For Jellyfin and media
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: streaming-chain
  namespace: traefik
spec:
  chain:
    middlewares:
      - name: crowdsec
      - name: rate-limit-streaming
      - name: timeout-streaming
