# =============================================================================
# Grafana Alerting Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting
  namespace: observability
data:
  alerting.yaml: |
    apiVersion: 1
    groups:
      - orgId: 1
        name: Infrastructure Alerts
        folder: Alerts
        interval: 1m
        rules:
          # High CPU Alert
          - uid: high-cpu
            title: High CPU Usage
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 5m
            annotations:
              summary: CPU usage is above 80% for 5 minutes
            labels:
              severity: warning
            isPaused: false

          # High Memory Alert
          - uid: high-memory
            title: High Memory Usage
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 5m
            annotations:
              summary: Memory usage is above 85% for 5 minutes
            labels:
              severity: warning
            isPaused: false

          # Pod Crash Looping
          - uid: pod-crashloop
            title: Pod CrashLooping
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 600
                  to: 0
                datasourceUid: mimir
                model:
                  expr: increase(kube_pod_container_status_restarts_total[10m]) > 5
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 600
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 0s
            annotations:
              summary: Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping
            labels:
              severity: critical
            isPaused: false

          # Pod Not Ready
          - uid: pod-not-ready
            title: Pod Not Ready
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: kube_pod_status_ready{condition="true"} == 0
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 5m
            annotations:
              summary: Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready
            labels:
              severity: warning
            isPaused: false

          # PVC Almost Full
          - uid: pvc-almost-full
            title: PVC Almost Full
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100 > 85
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 5m
            annotations:
              summary: PVC {{ $labels.persistentvolumeclaim }} is above 85% capacity
            labels:
              severity: warning
            isPaused: false

          # Node Not Ready
          - uid: node-not-ready
            title: Node Not Ready
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: kube_node_status_condition{condition="Ready",status="true"} == 0
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 5m
            annotations:
              summary: Node {{ $labels.node }} is not ready
            labels:
              severity: critical
            isPaused: false

          # Certificate Expiring Soon
          - uid: cert-expiring
            title: Certificate Expiring Soon
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: mimir
                model:
                  expr: (certmanager_certificate_expiration_timestamp_seconds - time()) < 1209600
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: C
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: __expr__
                model:
                  conditions:
                    - evaluator:
                        params: [0]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: [A]
                      reducer:
                        params: []
                        type: last
                      type: query
                  datasource:
                    type: __expr__
                    uid: __expr__
                  expression: A
                  intervalMs: 1000
                  maxDataPoints: 43200
                  type: threshold
            dashboardUid: ""
            panelId: 0
            noDataState: NoData
            execErrState: Error
            for: 1h
            annotations:
              summary: Certificate {{ $labels.name }} expires in less than 14 days
            labels:
              severity: warning
            isPaused: false

    contactPoints:
      - orgId: 1
        name: Discord
        receivers:
          - uid: discord-webhook
            type: discord
            settings:
              url: ${DISCORD_WEBHOOK_URL}
            disableResolveMessage: false

    policies:
      - orgId: 1
        receiver: Discord
        group_by:
          - grafana_folder
          - alertname
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
