# Setup Guide

This guide covers the prerequisites, secrets configuration, and deployment steps for the Interstellar homelab.

## üîê Required Secrets

Before deployment, configure these secrets in **Bitwarden Secrets Manager** and **GitHub repository settings**.

### How to Obtain Secrets

| Service                  | Documentation                                                                                        |
| ------------------------ | ---------------------------------------------------------------------------------------------------- |
| **Bitwarden SM**         | [Machine Accounts](https://bitwarden.com/help/machine-accounts/)                                     |
| **Tailscale API**        | [API Keys](https://tailscale.com/kb/1101/api#authentication)                                         |
| **Tailscale OAuth**      | [OAuth Clients](https://tailscale.com/kb/1215/oauth-clients)                                         |
| **OCI API Keys**         | [Required Keys and OCIDs](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm) |
| **Cloudflare API Token** | [Create API Token](https://developers.cloudflare.com/fundamentals/api/get-started/create-token/)     |
| **Proxmox API Token**    | [API Tokens](https://pve.proxmox.com/wiki/User_Management#_api_tokens)                               |
| **CrowdSec Bouncer Key** | [Bouncer Registration](https://docs.crowdsec.net/docs/next/bouncers/intro)                           |

### GitHub Repository Secrets

| Secret            | Description                                                             |
| ----------------- | ----------------------------------------------------------------------- |
| `BW_ACCESS_TOKEN` | Bitwarden machine account token (single project containing all secrets) |

### Bitwarden Secrets Manager

All secrets should be stored in a single Bitwarden Secrets Manager project:

#### OCI Secrets

| Key               | Description                                     |
| ----------------- | ----------------------------------------------- |
| `oci-config`      | Full `~/.oci/config` file content (without key) |
| `oci-private-key` | OCI API private key (PEM format)                |
| `oci-namespace`   | OCI Object Storage namespace                    |
| `tf-state-bucket` | OCI Object Storage bucket name                  |

#### Infrastructure Secrets

| Key                         | Description                                   | Required Permissions                                                          |
| --------------------------- | --------------------------------------------- | ----------------------------------------------------------------------------- |
| `tailscale-oauth-client-id` | Tailscale OAuth client ID                     | Scopes: `devices:core`, `keys:auth_keys` (Write) ‚Äî Tags: `tag:cluster,tag:ci` |
| `tailscale-oauth-secret`    | Tailscale OAuth client secret                 | -                                                                             |
| `tailscale-tailnet`         | Tailscale tailnet name (e.g. `example.org`)   | -                                                                             |
| `cloudflare-api-token`      | Cloudflare API token                          | `Zone:DNS:Edit`, `Zone:Zone:Read` for your domain                             |
| `cloudflare-zone-id`        | Cloudflare Zone ID                            | -                                                                             |
| `proxmox-api-token`         | Proxmox API token (`user@realm!token=secret`) | Full permissions on `/` or VM management                                      |
| `discord-webhook-url`       | Discord webhook for alerts                    | -                                                                             |
| `crowdsec-api-key`          | CrowdSec enrollment key                       | -                                                                             |
| `copyparty-admins`          | Comma-separated admin emails                  | -                                                                             |
| `copyparty-writers`         | Comma-separated writer emails                 | -                                                                             |

#### OAuth2 Proxy Secrets (Google OAuth)

| Key                                 | Description                         | How to Set                               |
| ----------------------------------- | ----------------------------------- | ---------------------------------------- |
| `oauth2-proxy-google-client-id`     | Google OAuth Client ID              | Create in GCP Console, copy to Bitwarden |
| `oauth2-proxy-google-client-secret` | Google OAuth Client Secret          | Same as above                            |
| `oauth2-proxy-cookie-secret`        | Cookie encryption secret (32 bytes) | Auto-generated by Terraform              |

**Google OAuth Client Setup:**

1. Go to [Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials](https://console.cloud.google.com/apis/credentials)
2. Click **Create Credentials ‚Üí OAuth Client ID**
3. Configure the OAuth consent screen if prompted (External, add your email)
4. Application type: **Web application**
5. Name: `Interstellar OAuth2 Proxy`
6. Authorized redirect URIs:
   - `https://auth.nerine.dev/oauth2/callback` (oauth2-proxy)
   - `https://grafana.nerine.dev/login/google` (Grafana)
7. Copy **Client ID** and **Client Secret** to Bitwarden

### Secrets Created by Terraform (do not set manually)

These are generated automatically during `terraform apply` and stored in Bitwarden:

| Secret                | Generated By                                 | Stored As                    |
| --------------------- | -------------------------------------------- | ---------------------------- |
| Tailscale auth key    | `tailscale_tailnet_key.cluster`              | `tailscale-auth-key`         |
| OAuth2 cookie secret  | `random_password.oauth2_proxy_cookie_secret` | `oauth2-proxy-cookie-secret` |
| Talos machine secrets | `talos_machine_secrets.cluster`              | Terraform state              |
| Kubeconfig            | `talos_cluster_kubeconfig.cluster`           | Terraform output             |
| Talosconfig           | `talos_machine_configuration`                | Terraform output             |

## üöÄ Bootstrap & Deployment

### Prerequisites

1. Domain configured in Cloudflare
2. Oracle Cloud account (free tier works)
3. Proxmox VE 8+ with IOMMU enabled
4. Bitwarden Secrets Manager account
5. Tailscale account with API access
6. Tools installed: `terraform`, `ansible`, `bws`, `tailscale`

### 1. Environment Setup

Clone the repository and load the environment variables from Bitwarden.

```bash
# 1. Clone the repository
git clone https://github.com/ThePhaseless/Interstellar.git
cd Interstellar

# 2.a. Set Bitwarden Access Token
export BWS_ACCESS_TOKEN="<your-token>"

# 2.b. Or create .env file in root of the repo
```

.env:
BWS_ACCESS_TOKEN="<your-token>"

```

# 3. Fetch secrets and setup environment
source scripts/setup-env.sh
```

This also writes `~/.talos/config` from the Bitwarden secret key `talosconfig` and attempts to configure kubectl via Tailscale using `talos-1` by default. Override with `TS_KUBECONFIG_TARGET=<hostname>` before sourcing if needed.

### 2. Ordered Bootstrap Runbook

Use this exact order.

#### Step A: Terraform init (local backend first)

```bash
cd Terraform

terraform init -backend=false
```

#### Step B: Terraform apply

```bash
terraform apply
```

#### Step C: Configure Oracle entrypoint

```bash
cd ../Ansible
ansible-playbook setup-oracle.yaml
```

#### Step D: Migrate Terraform state to OCI backend

```bash
cd ../Terraform
terraform init
```

Type `yes` when Terraform asks to copy local state to the remote backend.

#### Step E: Generate Bitwarden SDK TLS certificates

The External Secrets Operator requires TLS certificates for the Bitwarden SDK
server. Generate them once (valid for 10 years):

```bash
cd ..
./scripts/generate-bitwarden-tls.sh
```

This creates a `bitwarden-tls-certs` Secret in the `external-secrets` namespace.

#### Step F: Deploy Kubernetes bootstrap (without ArgoCD)

Deploy bootstrap infrastructure in order. CRDs must register between applies,
so each component is applied separately:

```bash
cd Kubernetes

# Phase 1: Foundation
kustomize build bootstrap/metallb --enable-helm | kubectl apply --server-side --force-conflicts -f -
# Wait for MetalLB controller to be ready
kubectl -n metallb-system wait --for=condition=ready pod -l app.kubernetes.io/component=controller --timeout=120s
# Re-apply to create IPAddressPool/L2Advertisement (requires webhook)
kustomize build bootstrap/metallb --enable-helm | kubectl apply --server-side --force-conflicts -f -

kustomize build bootstrap/nfs-csi --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/reloader --enable-helm | kubectl apply --server-side -f -

# Phase 2: Storage & Secrets
kustomize build bootstrap/longhorn --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/external-secrets --enable-helm | kubectl apply --server-side --force-conflicts -f -
# Wait for ESO pods, then re-apply to create ClusterSecretStore
kubectl -n external-secrets wait --for=condition=ready pod -l app.kubernetes.io/name=external-secrets --timeout=180s
# Set actual Bitwarden access token
kubectl -n external-secrets create secret generic bitwarden-access-token \
  --from-literal=token="$BWS_ACCESS_TOKEN" --dry-run=client -o yaml | kubectl apply --server-side -f -
kustomize build bootstrap/external-secrets --enable-helm | kubectl apply --server-side --force-conflicts -f -

# Phase 3: Networking & Security
kustomize build bootstrap/kube-api-lb --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/traefik --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/crowdsec --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/tailscale-operator --enable-helm | kubectl apply --server-side -f -

# Phase 4: Workloads & Observability
# Re-apply Longhorn to create IngressRoute (needs Traefik CRDs)
kustomize build bootstrap/longhorn --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/intel-gpu-operator --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/observability --enable-helm | kubectl apply --server-side -f -
kustomize build bootstrap/clamav --enable-helm | kubectl apply --server-side -f -
```

#### Step G: Deploy applications

```bash
kustomize build apps --enable-helm | kubectl apply --server-side -f -
```

#### Step H: Bootstrap ArgoCD (GitOps)

Once everything is verified, enable ArgoCD for continuous GitOps sync:

```bash
kubectl apply -k bootstrap/argocd
```

### 3. Post-bootstrap Validation

Run these checks after Step B:

```bash
# Kubernetes API and node readiness
kubectl get nodes -o wide

# Talos health from control host
talosctl health --nodes 192.168.1.111,192.168.1.112,192.168.1.113
```

Run these checks after Step F:

```bash
# Verify all bootstrap pods are running
kubectl get pods --all-namespaces

# ClusterSecretStore health
kubectl get clustersecretstore bitwarden-store

# MetalLB IP pool
kubectl -n metallb-system get ipaddresspool

# Longhorn storage
kubectl -n longhorn-system get pods

# Traefik ingress controller
kubectl -n traefik get pods
```

Confirm ArgoCD is managing the cluster resources (after Step H):

```bash
kubectl -n argocd get applications
```
