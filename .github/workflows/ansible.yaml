# =============================================================================
# Ansible CI/CD Workflow
# =============================================================================
# Lints Ansible playbooks on PRs and runs them on main branch pushes.
# Uses Tailscale for SSH access to infrastructure.

name: Ansible

on:
  push:
    branches: [main, migration]
    paths:
      - "Ansible/**"
      - "compose.proxy.yaml"
      - "haproxy.cfg"
      - ".github/workflows/ansible.yaml"
  pull_request:
    branches: [main, migration]
    paths:
      - "Ansible/**"
      - "compose.proxy.yaml"
      - "haproxy.cfg"
      - ".github/workflows/ansible.yaml"
  workflow_dispatch:
    inputs:
      playbook:
        description: "Playbook to run (e.g., setup-oracle.yaml)"
        required: true
        default: "setup-oracle.yaml"
        type: choice
        options:
          - setup-oracle.yaml
          - setup-proxmox.yaml
          - maintenance.yaml

env:
  ANSIBLE_DIR: "./Ansible"

jobs:
  # ---------------------------------------------------------------------------
  # Lint (runs on all PRs)
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv tool install ansible-core && uv tool install ansible-lint

      - name: Install Ansible collections
        run: ansible-galaxy install -r requirements.yaml
        working-directory: ${{ env.ANSIBLE_DIR }}

      - name: Run ansible-lint
        run: ansible-lint ${{ env.ANSIBLE_DIR }}

  # ---------------------------------------------------------------------------
  # Deploy (only on main branch or manual dispatch)
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # Fetch secrets from Bitwarden
      - name: Get Secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BW_ACCESS_TOKEN }}
          secrets: |
            tailscale-oauth-client-id > TS_OAUTH_CLIENT_ID
            tailscale-oauth-secret > TS_OAUTH_SECRET
            oracle-ssh-private-key > ORACLE_SSH_KEY
            tailscale-oracle-auth-key > TS_ORACLE_AUTHKEY

      # Connect to Tailscale for SSH access
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ env.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ env.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.ORACLE_SSH_KEY }}" > ~/.ssh/oracle_ed25519
          chmod 600 ~/.ssh/oracle_ed25519

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Ansible
        run: uv tool install ansible-core

      - name: Install Ansible collections
        run: ansible-galaxy install -r requirements.yaml
        working-directory: ${{ env.ANSIBLE_DIR }}

      # Determine which playbook to run
      - name: Set playbook
        id: playbook
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.playbook }}" >> $GITHUB_OUTPUT
          else
            # On push, run based on changed files
            CHANGED=$(git diff --name-only HEAD~1)
            if echo "$CHANGED" | grep -q "setup-proxmox"; then
              echo "name=setup-proxmox.yaml" >> $GITHUB_OUTPUT
            elif echo "$CHANGED" | grep -q "setup-oracle\|compose.proxy\|haproxy"; then
              echo "name=setup-oracle.yaml" >> $GITHUB_OUTPUT
            else
              echo "name=maintenance.yaml" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run Ansible playbook
        run: |
          ansible-playbook ${{ steps.playbook.outputs.name }} \
            -e "tailscale_authkey=${{ env.TS_ORACLE_AUTHKEY }}"
        working-directory: ${{ env.ANSIBLE_DIR }}
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
