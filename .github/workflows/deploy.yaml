name: Deploy Terraform Infrastructure
on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at 2 AM UTC to prevent artifact expiration
    - cron: "0 2 * * 0"
  push:
    branches:
      - main

concurrency:
  group: terraform
  cancel-in-progress: true

jobs:
  terraform:
    uses: ./.github/workflows/terraform.yaml
    secrets: inherit
  # ansible-proxmox:
  #   needs: terraform
  #   uses: ./.github/workflows/ansible-template.yaml
  #   with:
  #     ansible-group: "proxmox"
  #     playbook-name: "deploy-proxmox.yaml"
  #   secrets: inherit
  ansible-containers:
    needs: terraform
    uses: ./.github/workflows/ansible-template.yaml
    with:
      playbook-name: "deploy-containers.yaml"
      workflow-name: "Deploy Containers"
    secrets: inherit
  ansible-oracle:
    needs: terraform
    uses: ./.github/workflows/ansible-template.yaml
    with:
      playbook-name: "deploy-oracle.yaml"
      workflow-name: "Deploy Oracle"
    secrets: inherit
