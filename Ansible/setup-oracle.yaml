# Setup Oracle VPS instances for TalosOS infrastructure
# - oracle: All Oracle instances (proxy + compute)
# - oracle_proxy: Proxy VPS only (HAProxy + Docker)
# - oracle_compute: Compute VPS only (future workloads)

- name: Configure Oracle VPS Instances
  hosts: oracle
  become: true
  tasks:
    - name: Update packages
      ansible.builtin.import_tasks: tasks/update-apt.yaml

- name: Setup Tailscale on all Oracle instances
  hosts: oracle
  become: true
  vars_files:
    - vars/oracle.yaml
  roles:
    - role: artis3n.tailscale.machine

- name: Deploy HAProxy on Proxy VPS
  hosts: oracle_proxy
  become: true
  roles:
    - geerlingguy.docker
  tasks:
    - name: Create HAProxy directory
      ansible.builtin.file:
        path: /opt/haproxy
        state: directory
        mode: "0755"

    - name: Copy Docker Compose file
      ansible.builtin.copy:
        src: ../compose.proxy.yaml
        dest: /opt/haproxy/compose.yaml
        mode: "0644"

    - name: Copy HAProxy config
      ansible.builtin.copy:
        src: ../haproxy.cfg
        dest: /opt/haproxy/haproxy.cfg
        mode: "0644"
      notify: Restart HAProxy

    - name: Start HAProxy stack
      community.docker.docker_compose_v2:
        project_src: /opt/haproxy
        state: present
        pull: always

  handlers:
    - name: Restart HAProxy
      community.docker.docker_compose_v2:
        project_src: /opt/haproxy
        state: restarted
        services:
          - haproxy
