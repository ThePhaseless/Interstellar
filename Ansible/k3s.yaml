- name: Setup Containers
  hosts: localhost
  tasks:
    - name: Get latest k3s version
      register: k3s_version_json
      ansible.builtin.uri:
        url: https://api.github.com/repos/k3s-io/k3s/releases/latest
        return_content: true
    - name: Set K3S version fact
      ansible.builtin.set_fact:
        k3s_version: "{{ k3s_version_json.json.tag_name }}"
    - name: Print K3S version
      ansible.builtin.debug:
        msg: "Latest K3S version is {{ k3s_version }}"
    - name: Discover Proxmox Containers
      ansible.builtin.include_tasks: tasks/discover_tailscale.yaml

- name: Fix K3S Service
  hosts: k3s_cluster
  become: true
  tasks:
    - name: Ping cluster
      ansible.builtin.ping:
    - name: Create k3s service env file
      ansible.builtin.file:
        path: /etc/systemd/system/k3s.service.env
        mode: "0644"
        state: touch

- name: Fix K3S Agent Service
  hosts: agent
  become: true
  tasks:
    - name: Create k3s-agent service env file
      ansible.builtin.file:
        path: /etc/systemd/system/k3s-agent.service.env
        mode: "0644"
        state: touch

- name: Setup K3S
  ansible.builtin.import_playbook: k3s.orchestration.site
  vars:
    extra_server_args: "--flannel-iface=tailscale0 --flannel-backend=wireguard-native --flannel-external-ip"
    extra_agent_args: "--flannel-iface=tailscale0 --default-runtime=nvidia"
    k3s_version: "{{ hostvars['localhost']['k3s_version'] }}"
