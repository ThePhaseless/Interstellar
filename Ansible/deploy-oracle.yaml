---
- name: Deploy Tailscale on Oracle
  hosts: oracle
  vars_files:
    - vars/tailscale-oracle.yaml
  roles:
    - role: artis3n.tailscale.machine

- name: Install Docker
  hosts: oracle
  roles:
    - role: geerlingguy.docker
      become: true
      vars:
        docker_users:
          - "{{ ansible_user_id }}"

- name: Configure
  hosts: oracle
  tasks:
    - name: Update packages
      ansible.builtin.import_tasks: tasks/update-apt.yaml
    - name: Create repo folder
      become: true
      ansible.builtin.file:
        path: /opt/interstellar
        state: directory
        mode: "0755"
        owner: ${ ansible_user_id }

    - name: Get Github repository information # noqa: latest
      ansible.builtin.git:
        repo: "https://github.com/ThePhaseless/Interstellar.git"
        single_branch: true
        dest: "/opt/interstellar"
      register: repository_info

    - name: Deploy test compose
      community.docker.docker_compose_v2:
        project_src: "/opt/interstellar"
        files:
          - "compose.test.yaml"
        remove_orphans: true
        pull: always
