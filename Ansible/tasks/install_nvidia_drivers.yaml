- name: Check if Nvidia drivers are needed
  ansible.builtin.stat:
    path: /dev/nvidia0
  register: nvidia_drivers_needed
- name: Check if Nvidia drivers are installed
  ansible.builtin.stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_container_runtime
- name: Get current Nvidia driver version
  ansible.builtin.command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
  ignore_errors: true
  register: current_nvidia_driver_version
  changed_when: false
  when: nvidia_container_runtime.stat.exists
- name: Install Nvidia Drivers
  when: nvidia_drivers_needed.stat.exists and
    (
    not nvidia_container_runtime.stat.exists
    or current_nvidia_driver_version.stdout != nvidia_driver_version | default('')
    or current_nvidia_driver_version.rc != 0
    )
  block:
    - name: Get the latest Nvidia driver version
      ansible.builtin.uri:
        url: "https://download.nvidia.com/XFree86/Linux-x86_64/latest.txt"
        return_content: true
      register: nvidia_latest_version_raw
      when: nvidia_driver_version is not defined
    - name: Extract Nvidia driver version from response
      when: nvidia_driver_version is not defined
      ansible.builtin.set_fact:
        nvidia_latest_version: "{{ nvidia_latest_version_raw.content.split()[0] }}"
        nvidia_latest_version_filename: "{{ nvidia_latest_version_raw.content.split()[1] }}"
    - name: Set Nvidia driver version
      ansible.builtin.set_fact:
        nvidia_driver_path: >
          {{ nvidia_driver_version is defined | ternary(
              nvidia_driver_version + '/' + 'NVIDIA-Linux-x86_64-' + nvidia_driver_version + '.run',
              nvidia_latest_version_filename
          ) }}"
    - name: Download Nvidia driver
      changed_when: false
      ansible.builtin.get_url:
        url: "https://us.download.nvidia.com/XFree86/Linux-x86_64/{{ nvidia_driver_path }}"
        dest: /tmp/nvidia_driver.run
        mode: "0755"
    - name: Install Nvidia driver
      changed_when: true
      ansible.builtin.command: >-
        /tmp/nvidia_driver.run --silent
        {% if no_kernel_modules is defined %}
        --no-kernel-module
        {% endif %}
