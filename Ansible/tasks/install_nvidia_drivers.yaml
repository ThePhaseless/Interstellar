- name: Check if Nvidia drivers are needed
  ansible.builtin.stat:
    path: /dev/nvidia0
  register: nvidia_drivers_needed
- name: Check if Nvidia drivers are installed
  ansible.builtin.stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_container_runtime
- name: Get current Nvidia driver version
  ansible.builtin.command: nvidia-smi --query-gpu=driver_version --format=csv,noheader
  ignore_errors: true
  register: current_nvidia_driver_version
  changed_when: false
  when: nvidia_container_runtime.stat.exists
- name: Install Nvidia Drivers
  when: nvidia_drivers_needed.stat.exists and
    (
    not nvidia_container_runtime.stat.exists
    or current_nvidia_driver_version.stdout != nvidia_driver_version | default('')
    or current_nvidia_driver_version.rc != 0
    )
  block:
    - name: Install prerequisites for Nvidia driver
      tags:
        - skip_ansible_lint
      ansible.builtin.package:
        name:
          - binutils
          - make
          - gcc
          - "{{ linux_headers_package | default('linux-headers-{{ ansible_kernel }}') }}"
        state: latest
    - name: Download Nvidia driver
      changed_when: false
      vars:
        nvidia_driver_path: "{{ nvidia_driver_version }} + '/' + 'NVIDIA-Linux-x86_64-' + {{ nvidia_driver_version }} + '.run'"
      ansible.builtin.get_url:
        url: "https://us.download.nvidia.com/XFree86/Linux-x86_64/{{ nvidia_driver_path }}"
        dest: /tmp/nvidia_driver.run
        mode: "0755"
    - name: Install Nvidia driver
      changed_when: true
      ansible.builtin.command: >-
        /tmp/nvidia_driver.run --silent {{ '--no-kernel-module' if kernel_modules | default(true) else '' }}
