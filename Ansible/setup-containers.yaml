---
- name: Setup Containers
  hosts: proxmox
  tasks:
    - name: Configure Proxmox Containers
      ansible.builtin.include_tasks: tasks/update_container_configs.yaml
      loop: "{{ proxmox_containers_ids }}"
      loop_control:
        loop_var: container_id
    - name: Discover Proxmox Containers
      ansible.builtin.include_tasks: tasks/discover_proxmox.yaml
  vars_files:
    - vars/containers.yaml
    - ../.private/variables.yaml

- name: Install and run Tailscale
  hosts: containers
  vars_files:
    - vars/containers.yaml
  roles:
    - role: artis3n.tailscale.machine

- name: Update packages
  hosts: containers
  tasks:
    - name: Disable DNSStubListener
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: "^#?DNSStubListener="
        line: "DNSStubListener=no"
    - name: Install Nvidia Drivers
      ansible.builtin.include_tasks: tasks/install_nvidia_drivers.yaml
      vars:
        no_kernel_modules: true
        nvidia_driver_version: 580.76.05
    - name: Install Nvidia Container Toolkit
      ansible.builtin.include_tasks: tasks/install_nvidia_container_toolkit.yaml
    - name: Update apt packages
      ansible.builtin.import_tasks: tasks/update-apt.yaml
    - name: Make rootfs rshared on boot
      register: rc_local_exists
      ansible.builtin.copy:
        mode: "0777"
        dest: /etc/rc.local
        content: |
          #!/bin/sh -e
          mount --make-rshared /

    - name: Reboot to apply /etc/rc.local changes
      when: rc_local_exists is changed
      tags:
        - skip_ansible_lint
      changed_when: false
      ansible.builtin.reboot:
