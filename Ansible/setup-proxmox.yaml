- name: Setup Proxmox Host for TalosOS Cluster
  hosts: proxmox
  become: true
  vars_files:
    - vars/proxmox.yaml
  tasks:
    - name: Disable swap (current session)
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb > 0
      changed_when: false
      become: true

    - name: Disable swap (persist)
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: "swap"
        state: absent

    - name: Install targetcli
      ansible.builtin.apt:
        name: targetcli-fb
        state: present
        update_cache: true

    - name: Create ZFS zvol for cluster storage
      ansible.builtin.command:
        cmd: zfs create -V {{ zfs_storage_size }} {{ zfs_pool_name }}/k8s/storage
        creates: /dev/zvol/{{ zfs_pool_name }}/k8s/storage

    - name: Configure iSCSI target
      ansible.builtin.shell: |
        targetcli /backstores/block create k8s-storage /dev/zvol/{{ zfs_pool_name }}/k8s/storage || true
        targetcli /iscsi create {{ iscsi_target_iqn }} || true
        targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/luns create /backstores/block/k8s-storage || true
        for node in talos-1 talos-2 talos-3; do
          targetcli /iscsi/{{ iscsi_target_iqn }}/tpg1/acls create iqn.2026-01.dev.nerine:$node || true
        done
        targetcli saveconfig
      args:
        executable: /bin/bash
        creates: /etc/target/saveconfig.json

    - name: Enable and start target service
      ansible.builtin.systemd:
        name: target
        enabled: true
        state: started

  handlers: []
