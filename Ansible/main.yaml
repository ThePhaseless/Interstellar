- name: Import Proxmox containers
  ansible.builtin.import_playbook: ./playbooks/import_containers.yaml

- name: Configure Proxmox containers
  hosts: proxmox_containers
  tasks:
    - name: Ping all hosts
      ansible.builtin.ping:

    - name: Add device configuration to container {{ item.key }}
      ansible.builtin.blockinfile:
        path: "/etc/pve/lxc/{{ item }}.conf"
        marker: "# {mark} ANSIBLE MANAGED DEVICE CONFIG"
        block: |
          lxc.cgroup2.devices.allow: c 195:* rwm
          lxc.cgroup2.devices.allow: c 510:* rwm
          dev0: /dev/nvidia0
          dev1: /dev/nvidiactl
          dev2: /dev/nvidia-uvm
          dev3: /dev/nvidia-uvm-tools
          dev4: /dev/nvidia-caps/nvidia-cap1
          dev5: /dev/nvidia-caps/nvidia-cap2
          dev6: /dev/net/tun
        backup: true
      notify: restart_container_{{ item.key }}
      loop: "{{ container_ip_map }}"

  handlers:
    - name: Restart container {{ item.key }}
      listen: restart_container_{{ item.key }}
      ansible.builtin.command: "pct restart {{ item.key }}"
      changed_when: true
      notify: wait_for_container_{{ item.key }}

    - name: Wait for container {{ item.value }}
      listen: wait_for_container_{{ item.value }}
      ansible.builtin.wait_for:
        host: "{{ item.value }}"
        delay: 10
        timeout: 60

- name: Deploy
  hosts: all
  tasks:
